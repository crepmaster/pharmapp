# FILE STRUCTURE: ACTIVE VS OBSOLETE MODULES

**CRITICAL REFERENCE DOCUMENT - READ BEFORE MODIFYING CODE**

**Date Created**: 2025-10-23
**Last Updated**: 2025-10-24 (UnifiedAuthBloc migration complete + BLocProvider architecture fix)
**Purpose**: Prevent wasting time modifying obsolete/unused files

---

## üö® **CRITICAL WARNING**

**ALWAYS CHECK THIS DOCUMENT BEFORE MAKING CHANGES TO:**
- Registration screens
- Authentication flows
- Login screens
- Any screen with "unified" in the name

**We have lost multiple days modifying wrong files!** This document prevents that.

---

## ‚úÖ **UNIFIED REGISTRATION FLOW - ACTIVE FILES ONLY**

### **üì± THE CORRECT REGISTRATION PATH (Pharmacy & Courier Apps)**

```
Login Screen (tap "Sign Up")
    ‚Üì
PharmacyUnifiedRegistrationEntry (or CourierUnifiedRegistrationEntry)
    ‚Üì
SCREEN 1: CountryPaymentSelectionScreen
    ‚Üì (pushReplacement)
SCREEN 2: UnifiedRegistrationScreen (from pharmapp_unified package)
    ‚Üì (registration completes)
Auto sign-in via UnifiedAuthBloc
    ‚Üì (popUntil to root)
Back to Login Screen (but user is now authenticated)
    ‚Üì (AuthBloc detects Firebase Auth user via AuthStarted)
SCREEN 3: DashboardScreen (shown by AuthWrapper)
```

---

## üì¶ **ACTIVE FILES - REGISTRATION & AUTHENTICATION**

### **Entry Points (App-Specific)**

#### ‚úÖ **Pharmacy App Entry**
```dart
File: pharmacy_app/lib/screens/auth/pharmacy_unified_registration_entry.dart
Status: ‚úÖ ACTIVE - Currently used
Purpose: Entry point for pharmacy registration from login screen
Key Feature: Wraps UnifiedRegistrationScreen with userType: pharmacy
Usage: Navigator.push from login screen "Sign Up" button
```

#### ‚úÖ **Courier App Entry**
```dart
File: courier_app/lib/screens/auth/courier_unified_registration_entry.dart
Status: ‚úÖ ACTIVE - Currently used
Purpose: Entry point for courier registration from login screen
Key Feature: Wraps UnifiedRegistrationScreen with userType: courier
Usage: Navigator.push from login screen "Sign Up" button
```

---

### **Shared Registration Screens**

#### ‚úÖ **SCREEN 1: Country & City Selection**
```dart
File: shared/lib/screens/auth/country_payment_selection_screen.dart
Status: ‚úÖ ACTIVE - Shared between pharmacy & courier apps
Purpose: User selects country and city before registration
Features:
  - Country selection (Cameroon, Kenya, Nigeria, Ghana, etc.)
  - City selection (dynamic based on country)
  - Navigates to Screen 2 with pushReplacement
Navigation: pushReplacement ‚Üí UnifiedRegistrationScreen
```

#### ‚úÖ **SCREEN 2: Unified Registration Form**
```dart
File: pharmapp_unified/lib/screens/auth/unified_registration_screen.dart
Status: ‚úÖ ACTIVE - Shared between pharmacy & courier apps
Purpose: Main registration form (adapts to pharmacy/courier/admin roles)
Features:
  - Role-specific fields (pharmacy name vs courier name, etc.)
  - Payment method selection with encrypted preferences
  - Email/Password credentials
  - Uses UnifiedAuthService for backend
  - BlocListener for UnifiedAuthBloc.Authenticated state
Key Method: _handleRegistration() (line 730)
  - Calls UnifiedAuthService.signUp()
  - Auto sign-in via UnifiedAuthBloc.add(SignInRequested())
Navigation: popUntil((route) => route.isFirst) - line 824
  - Pops back to login screen
  - AuthWrapper automatically shows dashboard when AuthBloc detects Firebase user
```

#### ‚úÖ **SCREEN 3: Dashboard**
```dart
File: pharmacy_app/lib/screens/main/dashboard_screen.dart (pharmacy)
File: courier_app/lib/screens/main/dashboard_screen.dart (courier)
Status: ‚úÖ ACTIVE - App-specific dashboards
Purpose: Main app dashboard after successful registration
Navigation: Shown by AuthWrapper when AuthBloc emits AuthAuthenticated
```

---

### **Authentication Services**

#### ‚úÖ **Unified Auth Service**
```dart
File: shared/lib/services/unified_auth_service.dart
Status: ‚úÖ ACTIVE - Shared backend service
Purpose: Backend service for registration/authentication
Key Methods:
  - signUp() - Creates Firebase Auth user + Firestore documents
  - signIn() - Authenticates user and loads profile
  - getUserProfile() - Loads user data from Firestore
Features:
  - Multi-role support (pharmacy, courier, admin)
  - Encrypted payment preferences
  - Multi-country support
```

#### ‚úÖ **App-Specific Auth Service**
```dart
File: pharmacy_app/lib/services/auth_service.dart (pharmacy)
File: courier_app/lib/services/auth_service.dart (courier)
Status: ‚úÖ ACTIVE - App-specific wrappers
Purpose: App-specific authentication logic
Key Feature: Wraps UnifiedAuthService for app-specific needs
```

---

### **State Management (BLoC)**

#### ‚úÖ **UnifiedAuthBloc**
```dart
File: pharmapp_unified/lib/blocs/unified_auth_bloc.dart
Status: ‚úÖ ACTIVE - Used during registration flow
Purpose: Manages authentication state during unified registration
Events:
  - SignInRequested - Auto-triggered after successful registration
States:
  - Authenticated - Triggers navigation via BlocListener
Usage: Provided by PharmacyUnifiedRegistrationEntry/CourierUnifiedRegistrationEntry
```

#### ‚úÖ **App-Specific AuthBloc**
```dart
File: pharmacy_app/lib/blocs/auth_bloc.dart (pharmacy)
File: courier_app/lib/blocs/auth_bloc.dart (courier)
Status: ‚úÖ ACTIVE - Root-level auth state management
Purpose: Manages app-level authentication state
Events:
  - AuthStarted - Dispatched on app start (main.dart line 23)
  - AuthSignInRequested - Manual login
States:
  - AuthAuthenticated - Triggers AuthWrapper to show dashboard
  - AuthUnauthenticated - Shows login screen
Key Feature: AuthStarted checks AuthService.currentUser (Firebase Auth)
  - This is how it detects the new user after registration completes!
```

#### ‚úÖ **AuthWrapper**
```dart
File: pharmacy_app/lib/main.dart lines 40-79 (pharmacy)
File: courier_app/lib/main.dart (courier)
Status: ‚úÖ ACTIVE - Root navigation controller
Purpose: Shows Login vs Dashboard based on AuthBloc state
How It Works:
  - BlocBuilder<AuthBloc, AuthState>
  - if (state is AuthAuthenticated) ‚Üí shows DashboardScreen
  - if (state is AuthUnauthenticated) ‚Üí shows LoginScreen
```

---

## ‚ùå **DELETED FILES - MIGRATION COMPLETE (2025-10-24)**

### **‚ö†Ô∏è Old Authentication System (PERMANENTLY REMOVED)**

#### ‚ùå **auth_bloc.dart (Pharmacy App)**
```dart
File: pharmacy_app/lib/blocs/auth_bloc.dart
Status: ‚ùå DELETED - 2025-10-24
Reason: Replaced by UnifiedAuthBloc from pharmapp_unified package
Replacement: Use pharmapp_unified/lib/blocs/unified_auth_bloc.dart
Migration: pharmacy_app now uses UnifiedAuthBloc exclusively
```

#### ‚ùå **auth_bloc.dart (Courier App)**
```dart
File: courier_app/lib/blocs/auth_bloc.dart
Status: ‚ùå DELETED - 2025-10-24
Reason: Replaced by UnifiedAuthBloc from pharmapp_unified package
Replacement: Use pharmapp_unified/lib/blocs/unified_auth_bloc.dart
Migration: courier_app now uses UnifiedAuthBloc exclusively
Architecture Fix: Removed duplicate BlocProvider from courier_unified_registration_entry.dart
```

#### ‚ùå **register_screen.dart**
```dart
File: pharmacy_app/lib/screens/auth/register_screen.dart
Status: ‚ùå DELETED - 2025-10-24 (previously deprecated 2025-10-23)
Reason: Old single-app registration (before unified system)
Replacement: Use pharmapp_unified/lib/screens/auth/unified_registration_screen.dart
Migration: pharmacy_unified_registration_entry.dart now uses unified screens
```

#### ‚ùå **registration_navigation_helper.dart**
```dart
File: pharmacy_app/lib/services/registration_navigation_helper.dart
Status: ‚ùå DELETED - 2025-10-24 (previously deprecated 2025-10-23)
Reason: Caused navigation conflicts with AuthWrapper + duplicate BlocProvider issues
Replacement: No replacement needed - AuthWrapper handles navigation automatically
Architecture Fix: Single BlocProvider in main.dart, navigation via popUntil
```

#### ‚ùå **register_screen_test.dart**
```dart
File: pharmacy_app/test/screens/register_screen_test.dart
Status: ‚ùå DELETED - 2025-10-24
Reason: Test file for deleted register_screen.dart
Replacement: Will need new tests for unified registration flow
```

#### ‚ùå **unified_registration_service.dart**
```dart
File: shared/lib/services/unified_registration_service.dart
Status: ‚ùå OBSOLETE (likely unused)
Reason: Appears to be legacy code - not imported anywhere
Replacement: Use shared/lib/services/unified_auth_service.dart
Note: Contains similar problematic navigation patterns (pushAndRemoveUntil)
```

---

## üîç **HOW TO VERIFY WHICH FILE TO USE**

### **Before Modifying ANY Registration/Auth File:**

1. **Check this document** - Is the file marked as OBSOLETE?
2. **Check file deprecation header** - Does the file have a "‚ö†Ô∏è OBSOLETE FILE" banner?
3. **Check imports** - Run `git grep "import.*filename"` to see if it's actually used
4. **Check login screen** - What does "Sign Up" button navigate to?
   ```dart
   // pharmacy_app/lib/screens/auth/login_screen.dart line 208
   Navigator.push(
     context,
     MaterialPageRoute(
       builder: (context) => const PharmacyUnifiedRegistrationEntry(),
     ),
   );
   ```
5. **Trace the flow** - Follow the navigation chain to confirm

---

## üìä **NAVIGATION ARCHITECTURE EXPLANATION**

### **Why popUntil((route) => route.isFirst) is CORRECT:**

The unified registration uses `popUntil` (NOT explicit dashboard navigation) because:

1. **Registration completes** ‚Üí Creates Firebase Auth user
2. **Auto sign-in** ‚Üí Triggers UnifiedAuthBloc to emit Authenticated
3. **Pop to root** ‚Üí Returns to login screen
4. **AuthBloc detects new user** ‚Üí AuthStarted handler checks AuthService.currentUser
5. **AuthBloc emits AuthAuthenticated** ‚Üí AuthWrapper automatically shows dashboard

**This avoids race conditions** that occur when both:
- Explicit navigation tries to push dashboard
- AuthWrapper tries to show dashboard based on auth state

**The "back button shows dashboard" bug** was caused by explicit navigation COVERING the dashboard that AuthWrapper had already rendered.

---

## ‚ö†Ô∏è **COMMON MISTAKES TO AVOID**

### **Mistake #1: Modifying register_screen.dart**
```
‚ùå WRONG: "I need to fix registration, let me edit register_screen.dart"
‚úÖ RIGHT: "register_screen.dart is obsolete - edit unified_registration_screen.dart"
```

### **Mistake #2: Adding explicit navigation after registration**
```
‚ùå WRONG: Navigator.pushAndRemoveUntil(DashboardScreen) in registration helper
‚úÖ RIGHT: Let AuthWrapper handle navigation via AuthBloc state changes
```

### **Mistake #3: Creating separate pharmacy/courier registration screens**
```
‚ùå WRONG: Duplicate registration screens per app
‚úÖ RIGHT: One UnifiedRegistrationScreen, adapt via userType parameter
```

---

## üìã **DECISION TREE: Which File Should I Modify?**

```
Need to change registration flow?
‚îú‚îÄ Is it app-specific entry point? (e.g., pharmacy vs courier button text)
‚îÇ  ‚îî‚îÄ YES ‚Üí Edit pharmacy_unified_registration_entry.dart or courier_unified_registration_entry.dart
‚îÇ
‚îú‚îÄ Is it country/city selection UI?
‚îÇ  ‚îî‚îÄ YES ‚Üí Edit shared/lib/screens/auth/country_payment_selection_screen.dart
‚îÇ
‚îú‚îÄ Is it the main registration form?
‚îÇ  ‚îî‚îÄ YES ‚Üí Edit pharmapp_unified/lib/screens/auth/unified_registration_screen.dart
‚îÇ
‚îú‚îÄ Is it navigation after registration?
‚îÇ  ‚îî‚îÄ YES ‚Üí DON'T ADD EXPLICIT NAVIGATION! Check AuthWrapper/AuthBloc instead
‚îÇ
‚îú‚îÄ Is it backend registration logic?
‚îÇ  ‚îî‚îÄ YES ‚Üí Edit shared/lib/services/unified_auth_service.dart
‚îÇ
‚îî‚îÄ Is it authentication state management?
   ‚îú‚îÄ During registration? ‚Üí Edit pharmapp_unified/lib/blocs/unified_auth_bloc.dart
   ‚îî‚îÄ App-level auth? ‚Üí Edit pharmacy_app/lib/blocs/auth_bloc.dart (or courier equivalent)
```

---

## üéØ **SUMMARY: ONE WORKFLOW ONLY**

**Pharmacy App Registration:**
```
Login ‚Üí PharmacyUnifiedRegistrationEntry ‚Üí CountryPaymentSelectionScreen ‚Üí
UnifiedRegistrationScreen(userType: pharmacy) ‚Üí Auto sign-in ‚Üí Pop to root ‚Üí
AuthWrapper detects authenticated user ‚Üí Dashboard
```

**Courier App Registration:**
```
Login ‚Üí CourierUnifiedRegistrationEntry ‚Üí CountryPaymentSelectionScreen ‚Üí
UnifiedRegistrationScreen(userType: courier) ‚Üí Auto sign-in ‚Üí Pop to root ‚Üí
AuthWrapper detects authenticated user ‚Üí Dashboard
```

**Admin Registration (Future):**
```
Special admin panel ‚Üí UnifiedRegistrationScreen(userType: admin) ‚Üí Same flow
```

---

## üìù **CHANGELOG**

### 2025-10-23 - Complete Rewrite
- **Removed** all references to obsolete register_screen.dart as active
- **Added** comprehensive unified workflow documentation
- **Clarified** pharmacy_unified_registration_entry.dart vs unified_registration_screen.dart
- **Explained** why popUntil navigation is correct (avoids race conditions)
- **Deprecated** register_screen.dart and registration_navigation_helper.dart
- **Added** decision tree for file selection

### Previous
- Original document created with incorrect file classifications
- Lost multiple days modifying wrong files due to incomplete information

---

**Last Reviewed**: 2025-10-23
**Reviewer**: Claude (AI Assistant)
**Status**: Comprehensive - covers all registration/auth files
