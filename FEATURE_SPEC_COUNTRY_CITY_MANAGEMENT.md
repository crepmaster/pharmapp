# 🌍 Feature Specification: Country & City Management System

**Feature ID:** FEAT-001
**Created:** 2025-10-19
**Status:** 📋 Awaiting Architecture Review
**Reviewer:** pharmapp-reviewer agent

---

## 📋 **Purpose**

Enable dynamic country and city management through Firestore to support:
1. Admin can add new countries without app release
2. Admin can add/enable/disable cities without app release
3. Pharmacies and couriers can only operate in activated cities
4. Exchange matching limited to pharmacies in same city
5. Location validation during registration (20km radius)

---

## 🎯 **Business Requirements**

### **Year 1 Constraints:**
- Maximum 5 countries
- 2-3 active cities per country initially
- 1-2 new cities added per year
- 20km validation radius per city (moderate)
- Free GeoNames API for city data

### **Target Countries:**
1. 🇨🇲 Cameroon (XAF)
2. 🇰🇪 Kenya (KES)
3. 🇹🇿 Tanzania (TZS)
4. 🇺🇬 Uganda (UGX)
5. 🇳🇬 Nigeria (NGN)

---

## 📊 **Data Model**

### **Firestore Collections:**

```
countries/ (collection)
├── cameroon/ (document)
│   ├─ name: string                    "Cameroon"
│   ├─ code: string                    "CM" (ISO 3166-1 alpha-2)
│   ├─ currency: string                "XAF"
│   ├─ currencySymbol: string          "FCFA"
│   ├─ enabled: boolean                true
│   ├─ totalCities: number             3
│   ├─ activeCities: number            2
│   ├─ launchDate: Timestamp           2025-01-15
│   ├─ createdAt: Timestamp            auto
│   ├─ updatedAt: Timestamp            auto
│   └─ cities/ (subcollection)
│       ├── douala/ (document)
│       │   ├─ name: string            "Douala"
│       │   ├─ enabled: boolean        true
│       │   ├─ coordinates: GeoPoint   {lat: 4.051, lng: 9.768}
│       │   ├─ validationRadius: number 20 (km)
│       │   ├─ population: number      2765000
│       │   ├─ region: string          "Littoral"
│       │   ├─ timezone: string        "Africa/Douala"
│       │   ├─ deliveryFee: number     1000 (XAF)
│       │   ├─ pharmacyCount: number   0 (computed)
│       │   ├─ courierCount: number    0 (computed)
│       │   ├─ autoGenerated: boolean  true (from GeoNames)
│       │   ├─ launchDate: Timestamp   2025-01-15
│       │   ├─ createdAt: Timestamp    auto
│       │   └─ updatedAt: Timestamp    auto
│       │
│       └── yaounde/
│           └─ ... (same structure)
│
└── kenya/
    └─ ... (same structure)

pharmacies/ (existing collection - UPDATED)
├── {uid}/
│   ├─ countryId: string               "cameroon" (NEW)
│   ├─ countryName: string             "Cameroon" (NEW - denormalized)
│   ├─ cityId: string                  "douala" (NEW)
│   ├─ cityName: string                "Douala" (NEW - denormalized)
│   ├─ currency: string                "XAF" (EXISTING - kept for consistency)
│   ├─ location: Map                   (NEW)
│   │   ├─ coordinates: GeoPoint       {lat, lng}
│   │   ├─ address: string             Full address
│   │   ├─ distanceFromCity: number    12.5 (km)
│   │   └─ validated: boolean          true
│   └─ ... (existing fields)
```

---

## 🔌 **API Contract**

### **GeoNames API Integration:**

**Endpoint:** `http://api.geonames.org/searchJSON`

**Request:**
```
GET http://api.geonames.org/searchJSON?
  country=CM&
  featureCode=PPLA,PPLC&
  orderby=population&
  maxRows=20&
  username=pharmapp
```

**Response:**
```json
{
  "geonames": [
    {
      "name": "Douala",
      "lat": "4.04827",
      "lng": "9.70428",
      "population": 2765000,
      "adminName1": "Littoral",
      "countryCode": "CM"
    }
  ]
}
```

### **Firebase Functions (New):**

#### **1. Location Validation Function:**
```typescript
// functions/src/location/validatePharmacyLocation.ts

interface ValidationRequest {
  countryId: string;
  cityId: string;
  latitude: number;
  longitude: number;
}

interface ValidationResponse {
  valid: boolean;
  distance: number; // km from city center
  message: string;
  confidence: 'high' | 'medium' | 'low';
}

export const validatePharmacyLocation = onCall<ValidationRequest>(
  async (request) => {
    // Implementation details below
  }
);
```

#### **2. Fetch Cities from GeoNames:**
```typescript
// functions/src/admin/fetchCitiesFromGeoNames.ts

interface FetchCitiesRequest {
  countryCode: string; // ISO alpha-2 (e.g., "CM")
  maxResults: number;  // Default 20
}

interface CityData {
  name: string;
  lat: number;
  lng: number;
  population: number;
  region: string;
}

export const fetchCitiesFromGeoNames = onCall<FetchCitiesRequest>(
  async (request) => {
    // Returns array of CityData
  }
);
```

---

## 🏗️ **Architecture**

### **Clean Architecture Layers:**

```
📁 features/country_management/
├── 📁 data/
│   ├── 📁 models/
│   │   ├── country_model.dart          (Firestore ↔ Entity)
│   │   └── city_model.dart
│   ├── 📁 repositories/
│   │   ├── country_repository_impl.dart
│   │   └── city_repository_impl.dart
│   └── 📁 data_sources/
│       ├── country_remote_data_source.dart (Firestore)
│       └── geonames_data_source.dart       (GeoNames API)
│
├── 📁 domain/
│   ├── 📁 entities/
│   │   ├── country.dart                (Business entity)
│   │   └── city.dart
│   ├── 📁 repositories/
│   │   ├── country_repository.dart     (Interface)
│   │   └── city_repository.dart
│   └── 📁 usecases/
│       ├── get_active_countries.dart
│       ├── get_cities_by_country.dart
│       ├── validate_city_location.dart
│       └── fetch_cities_from_geonames.dart
│
└── 📁 presentation/
    ├── 📁 blocs/
    │   ├── country_bloc.dart
    │   └── city_bloc.dart
    ├── 📁 screens/
    │   └── country_selection_screen.dart
    └── 📁 widgets/
        ├── country_card.dart
        └── city_list_item.dart
```

---

## 🎨 **UI Mockup**

### **User Registration - Country Selection:**
```
┌─────────────────────────────────────┐
│ ← Select Your Country               │
├─────────────────────────────────────┤
│                                     │
│ Choose your pharmacy location:     │
│                                     │
│ ┌─────────────────────────────────┐│
│ │ 🇨🇲 Cameroon                     ││
│ │ XAF - Central African CFA Franc ││
│ │ 3 cities available              ││
│ └─────────────────────────────────┘│
│                                     │
│ ┌─────────────────────────────────┐│
│ │ 🇰🇪 Kenya                        ││
│ │ KES - Kenyan Shilling           ││
│ │ 2 cities available              ││
│ └─────────────────────────────────┘│
│                                     │
│ ... (3 more countries)              │
│                                     │
└─────────────────────────────────────┘
```

### **User Registration - City Selection:**
```
┌─────────────────────────────────────┐
│ ← Select City in Cameroon           │
├─────────────────────────────────────┤
│                                     │
│ Active cities:                      │
│                                     │
│ ┌─────────────────────────────────┐│
│ │ 📍 Douala                        ││
│ │ Economic capital • 2.7M people  ││
│ │ Littoral Region                 ││
│ └─────────────────────────────────┘│
│                                     │
│ ┌─────────────────────────────────┐│
│ │ 📍 Yaoundé                       ││
│ │ Political capital • 2.4M people ││
│ │ Centre Region                   ││
│ └─────────────────────────────────┘│
│                                     │
│ Other cities coming soon...         │
│                                     │
└─────────────────────────────────────┘
```

### **Admin Panel - Add City:**
```
┌─────────────────────────────────────────┐
│ Add City to Kenya                       │
├─────────────────────────────────────────┤
│ [Fetch from GeoNames]                   │
│                                         │
│ Results:                                │
│ ┌─────────────────────────────────────┐ │
│ │ ☐ Kisumu (410K) [-0.091, 34.768]  │ │
│ │ ☐ Nakuru (307K) [-0.303, 36.080]  │ │
│ │ ☐ Eldoret (290K) [0.520, 35.270]  │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ OR Enter Manually:                      │
│ Name: [____________]                    │
│ Lat:  [____________]                    │
│ Lng:  [____________]                    │
│ Radius: [20] km                         │
│                                         │
│ [Cancel] [Add Selected]                 │
└─────────────────────────────────────────┘
```

---

## 🧪 **Test Cases**

### **Test 1: Get Active Countries**
```dart
test('should return only enabled countries', () async {
  // Given: 5 countries in Firestore, 2 disabled
  // When: getActiveCountries() called
  // Then: Returns 3 countries
  // And: All have enabled = true
});
```

### **Test 2: Get Cities by Country**
```dart
test('should return only enabled cities for country', () async {
  // Given: Kenya has 3 cities, 1 disabled
  // When: getCitiesByCountry('kenya') called
  // Then: Returns 2 cities
  // And: All have enabled = true
});
```

### **Test 3: Validate Location - Within Radius**
```dart
test('should validate location within 20km radius', () async {
  // Given: User at lat: 4.060, lng: 9.770
  // And: Douala center at lat: 4.051, lng: 9.768
  // When: validateLocation() called
  // Then: Returns valid = true
  // And: Distance ≈ 1.0km
});
```

### **Test 4: Validate Location - Outside Radius**
```dart
test('should reject location outside radius', () async {
  // Given: User at lat: 3.867, lng: 11.517 (Yaoundé)
  // And: Selected city is Douala
  // When: validateLocation() called
  // Then: Returns valid = false
  // And: Distance ≈ 210km
  // And: Message contains error
});
```

### **Test 5: Fetch Cities from GeoNames**
```dart
test('should fetch cities from GeoNames API', () async {
  // Given: Country code "CM"
  // When: fetchCitiesFromGeoNames() called
  // Then: Returns list of cities
  // And: Each city has name, lat, lng, population
  // And: Ordered by population desc
});
```

---

## 🔐 **Security Considerations**

### **Firestore Rules:**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Countries - Read by all, Write by admin only
    match /countries/{countryId} {
      allow read: if true; // Public read
      allow write: if request.auth != null &&
                      get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isSuperAdmin == true;

      // Cities - Same rules as parent
      match /cities/{cityId} {
        allow read: if true;
        allow write: if request.auth != null &&
                        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isSuperAdmin == true;
      }
    }

    // Pharmacies - Updated validation
    match /pharmacies/{pharmacyId} {
      allow create: if request.auth != null &&
                       request.auth.uid == pharmacyId &&
                       // Validate country and city exist and are enabled
                       exists(/databases/$(database)/documents/countries/$(request.resource.data.countryId)) &&
                       exists(/databases/$(database)/documents/countries/$(request.resource.data.countryId)/cities/$(request.resource.data.cityId)) &&
                       get(/databases/$(database)/documents/countries/$(request.resource.data.countryId)/cities/$(request.resource.data.cityId)).data.enabled == true;
    }
  }
}
```

---

## 📝 **Implementation Phases**

### **Phase 1: Data Models (Week 1, Day 1-2)**
**Files to create:**
- `shared/lib/features/country_management/domain/entities/country.dart`
- `shared/lib/features/country_management/domain/entities/city.dart`
- `shared/lib/features/country_management/data/models/country_model.dart`
- `shared/lib/features/country_management/data/models/city_model.dart`

**Dependencies:** None

### **Phase 2: Repositories (Week 1, Day 3-4)**
**Files to create:**
- `shared/lib/features/country_management/domain/repositories/country_repository.dart` (interface)
- `shared/lib/features/country_management/data/repositories/country_repository_impl.dart`
- `shared/lib/features/country_management/data/data_sources/country_remote_data_source.dart`

**Dependencies:** Phase 1 complete

### **Phase 3: Use Cases (Week 1, Day 5)**
**Files to create:**
- `shared/lib/features/country_management/domain/usecases/get_active_countries.dart`
- `shared/lib/features/country_management/domain/usecases/get_cities_by_country.dart`
- `shared/lib/features/country_management/domain/usecases/validate_city_location.dart`

**Dependencies:** Phase 2 complete

### **Phase 4: BLoC State Management (Week 2, Day 1-2)**
**Files to create:**
- `pharmacy_app/lib/features/country_management/presentation/blocs/country_bloc.dart`
- `pharmacy_app/lib/features/country_management/presentation/blocs/country_event.dart`
- `pharmacy_app/lib/features/country_management/presentation/blocs/country_state.dart`

**Dependencies:** Phase 3 complete

### **Phase 5: UI Components (Week 2, Day 3-4)**
**Files to create:**
- `pharmacy_app/lib/features/country_management/presentation/screens/country_selection_screen.dart`
- `pharmacy_app/lib/features/country_management/presentation/widgets/country_card.dart`

**Dependencies:** Phase 4 complete

### **Phase 6: Backend Functions (Week 2, Day 5)**
**Files to create:**
- `functions/src/location/validatePharmacyLocation.ts`
- `functions/src/admin/fetchCitiesFromGeoNames.ts`

**Dependencies:** None (parallel development)

---

## ✅ **Acceptance Criteria**

### **User Stories:**

**US-001:** As a pharmacy, I want to select my country during registration
- [ ] Country selection screen appears first
- [ ] Only enabled countries shown
- [ ] Each country shows currency and city count
- [ ] Selection persists through registration flow

**US-002:** As a pharmacy, I want to select my city during registration
- [ ] City selection appears after country
- [ ] Only enabled cities for selected country shown
- [ ] Each city shows population and region
- [ ] Cannot proceed without city selection

**US-003:** As a pharmacy, my location should be validated
- [ ] GPS coordinates captured during registration
- [ ] Distance from city center calculated
- [ ] Warning shown if >20km from city
- [ ] Registration blocked if >30km from city

**US-004:** As an admin, I want to add a new country
- [ ] Can enter country details manually
- [ ] Can fetch cities from GeoNames
- [ ] Can select which cities to activate
- [ ] Changes reflect immediately in app

**US-005:** As an admin, I want to manage cities
- [ ] Can enable/disable cities
- [ ] Can add new city to existing country
- [ ] Can see pharmacy count per city
- [ ] Can set delivery fee per city

---

## 🚀 **Ready for Review**

**Reviewer:** @pharmapp-reviewer agent

**Review Focus:**
1. ✅ Architecture follows Clean Architecture principles?
2. ✅ Data model supports all requirements?
3. ✅ API contract well-defined?
4. ✅ Security rules adequate?
5. ✅ Test cases comprehensive?
6. ✅ Implementation phases realistic?

**Next Steps After Approval:**
1. Create Phase 1 files (Domain entities)
2. Submit each file for syntax review
3. Proceed to Phase 2 after approval

---

**Specification Version:** 1.0
**Last Updated:** 2025-10-19
**Status:** 📋 Awaiting Architecture Review
